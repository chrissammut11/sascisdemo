<!--we used https://canada.viya4.sasdemo.ca/SASVisualAnalytics/resources/custom_table.html 
    as the basis for this page --> 
<!doctype html> 
<html> 
<head> 
<title>SAS Visual Analytics Custom Data Table</title> 
  <script type="text/javascript" src="util/messagingUtil.js"></script> 
  <script type="text/javascript" src="util/jobExecutionUtil.js"></script> 
  <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script> 
<style> 
    body {font-family: AvenirNext, Helvetica, Arial, sans-serif;  
          font-size: .8889rem;  
          background-color: #80b0ef;}  
    table {border-collapse: collapse;}  
    th {text-align: left;}  
    th, td {padding: 0.25rem .5rem;}  
    tbody, tr + tr {border-top: 1px solid rgb(231, 231, 231);}  
    th + th, td + td {border-left: 1px solid rgb(231, 231, 231);}  
    .numeric {text-align: right;}  
    body::-webkit-scrollbar {width: 0.5em;}  
    body::-webkit-scrollbar:horizontal {height: 0.5em;}  
    body::-webkit-scrollbar-thumb {background-color: darkgrey;outline: 1px solid slategrey;}  
    body::-webkit-scrollbar-button {display: none;}  
    #sample {display: block;}  
    .additional-info {width: 100%;padding: 10px;border: 1px solid #ccc;border-radius: 4px;box-sizing: border-box;font-size: 16px;}  
    .spinner {display: none;width: 50px;height: 50px;border: 5px solid #f3f3f3;border-top: 5px solid #3498db;border-radius: 50%;animation: spin 1s linear infinite;}  
    @keyframes spin {0% { transform: rotate(0deg); }25% { transform: rotate(90deg); }50% { transform: rotate(180deg); }75% { transform: rotate(270deg); }100% { transform: rotate(360deg); }}  
    .message {display: none;margin-top: 20px;font-size: 18px;color: rgb(0, 128, 11);}  
</style> 
</head> 
<body> 
<div id="instruction"> 
<!-- <p>The data-driven content object enables you to incorporate your own content, like a calendar object, into a SAS Visual Analytics report.</p> --> 
</div><div id="sample"></div> 
<form id="myForm"> 
<script> 
    /* EVENT HANDLERS */ 
    var self = this; 
 
	let VAcol_labels = []; 
   let TOTcol_labels = []; 
 
    // Retrieve data and begin processing 
    function onMessage(evt) { 
        if (evt && evt.data) { 
            var results = null; 
            var columnInfo = null; 
            self.resultName = evt.data.resultName; 
 
            if (evt.data.availableRowCount >= 0) { 
                results = evt.data; 
                columnInfo = evt.data.columns; 
 
			VAcol_labels = columnInfo.map(column => "VA_"+column.label); 
 
			//Add any input/select columns here start with bi901 
           // the following are examples of text input, drop-down, radio button, and date fields 
                evt.data.columns.push({"name":"ADD901_CNotes1","label":"Notes1","type":"text","class":"additional-info"});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                evt.data.columns.push({"name":"ADD902_NPreferred_Language","label":"Preferred_Language","type":"text"});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                evt.data.columns.push({"name":"ADD903_DReview_Date","label":"Review_Date","type":"date"});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                evt.data.columns.push({"name":"ADD904_CHigh_Risk_Client","label":"High_Risk_Client","type":"text"});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                evt.data.columns.push({"name":"ADD905_CNotes2","label":"Notes2","type":"text","class":"additional-info"});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
 
           // Extract substring from name property 
           TOTcol_labels = columnInfo.map(column => { 
				if (column.name.startsWith("ADD9")) { 
					return column.name.substring(column.name.indexOf('_') + 1); 
                    } 
					return column.name; 
                }); 
 
			let numElementsToReplace = VAcol_labels.length; 
			for (let i = 0; i < numElementsToReplace; i++) { 
				TOTcol_labels[i] = VAcol_labels[i]; 
			} 
		} 
            else if (evt.data.availableRowCount == -1) { 
                results = sampleData; 
                columnInfo = sampleColumnInfo; 
            } 
 
            if(results) { 
                jsonToTable(columnInfo, results.data); 
            } 
        } 
    } 
 
    if (window.addEventListener) { 
        // For standards-compliant web browsers 
        window.addEventListener("message", onMessage, false); 
    } else { 
        window.attachEvent("onmessage", onMessage); 
    } 
 
    // Update the object's selection when a row is checked/unchecked 
    function sendSelection(evt) { 
        //var selectedRows = document.querySelectorAll(':checked'); 
        var selectedRows = document.querySelectorAll('.row-select:checked');

        var selection = []; 
        for (var i = 0; i < selectedRows.length; i++) 
        { 
            var row = selectedRows[i]; 
            selection.push({row: row.id}); 
        } 
 
        var message = { 
            resultName: self.resultName, 
            selections: selection 
        }; 
 
        sendMessage(message); 
    } 
 
    function sendMessage(message) 
    { 
        var url = (window.location != window.parent.location) 
            ? document.referrer 
            : document.location.href; 
 
        window.parent.postMessage(message, url); 
    } 
 
    /*  TABLE CREATION  */ 
    // Create an HTML DOM element of the given type containing the given text 
    function createElementWithText(element, text) { 
        var e = document.createElement(element); 
        e.appendChild(document.createTextNode(text)); 
        return e; 
    } 
 
    // Process the array of CSV data and create a table 
    function jsonToTable(columnInfo, jsonData) { 
 
        // Create table 
        var tableDivId = 'sample'; // identifier for the table's parent/container 
        var tableDiv = document.getElementById(tableDivId); 
 
        // If a table already exists in our custom div, remove it 
        tableDiv.innerHTML = ""; 
 
        var table = tableDiv.appendChild(document.createElement('table')); 
        var lastColumnIsSelectionData = false; 
        // Create headers from column info 
        addHeaderRow(columnInfo.filter(function (c) { 
            if (c.usage == "brush") { 
                lastColumnIsSelectionData = true; 
                return false; 
            } 
            return true; 
        }).map(function (c) { 
            return c.label; 
        })); 
 
        // Create table body for incoming data 
        var tableBody = table.appendChild(document.createElement('tbody')); 
 
        // Add remaining rows to table body 
        if (jsonData) { 
            for (var i = 0; i < jsonData.length; i++) { 
                addDataRow(jsonData[i], lastColumnIsSelectionData); 
            } 
        } 
 
        // Append a header row to the table 
        function addHeaderRow(columnLabels) { 
            // Create table row 
            var tableHead = document.createElement('thead'); 
            var tr = document.createElement('tr'); 
 
            // Add a blank cell for checkbox/selection column 
            tr.appendChild(document.createElement('th')); 
 
            // Add a header cell for each column heading 
            columnLabels.forEach(function (header) { 
                tr.appendChild(createElementWithText('th', header)); 
            }); 
            tr.appendChild(document.createElement('th')); 
 
            tableHead.appendChild(tr); 
            table.appendChild(tableHead); 
        } 
 
        // Append a data row to the table 
        function addDataRow(dataFields, lastColumnIsSelectionData) { 
            addDataRow.rowNum = ++addDataRow.rowNum || 0; 
            var tr = document.createElement('tr'); 
 
            // Add a checkbox/selector with ID to each row 
            var checkbox = document.createElement('input'); 
            checkbox.type = 'checkbox'; 
            checkbox.setAttribute('id', addDataRow.rowNum); 
            checkbox.setAttribute('class', 'row-select'); 
            checkbox.addEventListener('click', sendSelection); 
            checkbox.checked = true; 
            checkbox.hidden = true; 
 
            var checkboxCell = document.createElement('td'); 
            checkboxCell.appendChild(checkbox); 
            tr.appendChild(checkboxCell); 
 
            // Add table cell for each data field 
            dataFields.forEach(function (field, index) { 
                if (lastColumnIsSelectionData && index == dataFields.length - 1) { 
                    if (field > 0) 
                        checkbox.checked = true; 
                    return; 
                } 
                var td = createElementWithText('td', field); 
                if (!isNaN(field)) { 
                    td.className = 'numeric'; // Set numeric class to align numeric cells 
                } 
                tr.appendChild(td); 
            }); 
 
      //Add your own input/select elements and text below here 
 	var inputbox = document.createElement('input');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
 	inputbox.type = 'text';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
 	inputbox.setAttribute('id', 'text1'+addDataRow.rowNum);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var inputboxCell = document.createElement('td');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 	inputboxCell.appendChild(inputbox);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
 	tr.appendChild(inputboxCell);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var selectbox = document.createElement('select');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 	selectbox.setAttribute('id', 'select2' + addDataRow.rowNum);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	// code to add options to the selectbox element                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
 	var options = [' ' ,'1' ,'2' ]; //these will be the numeric values passed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 	var optionArray = ['--select--' ,'English' ,'French' ]; //these are the options displayed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 	options.forEach(function(optionText, index) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	var option = document.createElement('option');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	option.value = optionText.replace(' ', '-');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
 	option.text = optionArray[index]; //optionText-this was the default;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
 	selectbox.appendChild(option);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	});                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var selectboxCell = document.createElement('td');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 	selectboxCell.appendChild(selectbox);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 	tr.appendChild(selectboxCell);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	// Add date input element                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 	var dateInput = document.createElement('input');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 	dateInput.type = 'date';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
 	dateInput.setAttribute('id', 'date3' + addDataRow.rowNum);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var dateInputCell = document.createElement('td');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 	dateInputCell.appendChild(dateInput);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 	tr.appendChild(dateInputCell);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var radioCell = document.createElement('td');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	var radio1 = document.createElement('input');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	radio1.type = 'radio';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
 	radio1.name = 'radio' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
 	radio1.value = 'Yes';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 	radio1.id = 'yes' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
 	var label1 = document.createElement('label');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	label1.htmlFor = 'yes' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
 	label1.appendChild(document.createTextNode('Yes'));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
 	radioCell.appendChild(radio1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	radioCell.appendChild(label1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var radio2 = document.createElement('input');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	radio2.type = 'radio';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
 	radio2.name = 'radio' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
 	radio2.value = 'No';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
 	radio2.id = 'no' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 	var label2 = document.createElement('label');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 	label2.htmlFor = 'no' + addDataRow.rowNum;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
 	label2.appendChild(document.createTextNode('No'));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 	radioCell.appendChild(radio2);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	radioCell.appendChild(label2);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	tr.appendChild(radioCell);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var inputbox = document.createElement('input');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
 	inputbox.type = 'text';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
 	inputbox.setAttribute('id', 'text5'+addDataRow.rowNum);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 	var inputboxCell = document.createElement('td');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 	inputboxCell.appendChild(inputbox);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
 	tr.appendChild(inputboxCell);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            tableBody.appendChild(tr); 
        } 
    } 
</script> 
 <BR><BR> 
 <button onclick="submitSelections()">Submit Selections</button> 
 </form> 
 <br><br> 
 <div class="spinner" id="spinner"></div> 
 <div class="message" id="message2">Job is processing</div> 
  
 <div class="message" id="message">Data processed successfully!</div> 
  
 <script> 
function submitSelections() {
    const selectedRows = [];
    const checkboxes = document.querySelectorAll('.row-select:checked');

    checkboxes.forEach((checkbox) => {
        const row = checkbox.closest('tr'); // Get the row for the selected checkbox
        let rowData = {};
        let cells = row.querySelectorAll('td'); // Get all table cells in order

        let colIndex = 0;

        cells.forEach((cell) => {
            // Skip the checkbox column
            if (cell.querySelector('.row-select')) return;

            // Check if the cell contains an input, select, or radio
            let input = cell.querySelector('input, select, textarea');

            if (input) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    if (input.checked) {
                        rowData[TOTcol_labels[colIndex]] = input.value;
                    }
                } else {
                    rowData[TOTcol_labels[colIndex]] = input.value.trim();
                }
            } else {
                // If no input, extract plain text (for static table data)
                rowData[TOTcol_labels[colIndex]] = cell.innerText.trim();
            }
            colIndex++;
        });

        selectedRows.push(rowData);
    });

    const url = "https://canada.viya4.sasdemo.ca";
    const parameters = {
        "_program": "/Public/ChrisS/GitHub_DDC/save_data_from_VA_v5",
        "clib": "PUBLIC",
        "sourcedsn": "CANCSS_TAX_REVIEW",
        "historydsn": "CANCSS_TAXREV_HISTORYV5"
    };

    // executeJob(url, selectedRows, parameters).then(response => console.log(response));
    executeJob(url, selectedRows, parameters).then(response => {
    console.log(response);
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('message').style.display = 'block';
});


}
  
 document.getElementById('myForm').addEventListener('submit', function(event) { 
     event.preventDefault(); // Prevent the default form submission 
  
 //this section deals with spinner and message after job has been submitted 
  
     // Show the spinner 
     document.getElementById('spinner').style.display = 'block'; 
     document.getElementById('message2').style.display = 'block'; 
  
     // Simulate data processing with a timeout 
     setTimeout(function() { 
         // Hide the spinner after processing 
         document.getElementById('spinner').style.display = 'none'; 
         // Show the success message 
         document.getElementById('message').style.display = 'block'; 
         document.getElementById('message2').style.display = 'none'; 
  
         // Hide the success message after 3 seconds 
         setTimeout(function() { 
             document.getElementById('message').style.display = 'none'; 
         }, 5000); // 5 seconds 
  
     }, 25000); // Simulate an n-second processing time 
  
     }); 
  
 </script> 
 </body> 
 </html> 
